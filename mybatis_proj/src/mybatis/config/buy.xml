<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mybatis.mapper.BuyMapper">
  <!-- join SQL, 집계함수 ... -->
  <!-- day05_(3)문제_select.sql 의 10번 -->
  <select id="selectSaleByCustomer" parameterType="string" resultType="CustomerBuyVo">
    SELECT tp.PCODE, pt.PNAME, tp.PRICE, pt.PRICE * tb.QUANTITY AS money
    FROM TBL_PRODUCT pt
    JOIN TBL_BUY tb
    ON pdt.PCODE = buy.PCODE
    WHERE buy.CUSTOMER_ID= #{customer_id}
  </select>

  <!-- day05_(3)문제_select.sql 의 9번 추가문제 1 -->
<select id="selectCountByYear" parameterType="string" resultType="map">
  <!-- 집계 함수의 결과가 1개 행. 조회 컬럼 2개일 때 효율적인 방법으로 Map 을 사용할 수 있습니다. -->
  <!-- 마이바티스는 YEAR, COUNT 컬럼명을 key 로 하여 각 컬럼의 값은 value 로 HashMap 객체 저장 -->
    SELECT EXTRACT(YEAR FROM BUY_DATE) AS year, COUNT(*) AS count
    FROM TBL_BUY tb
    GROUP BY EXTRACT(YEAR FROM BUY_DATE)
    HAVING EXTRACT(YEAR FROM BUY_DATE)=#{year}
</select>

<select id="selectAllCountByYear" parameterType="string" resultType="map">
  <!-- 집계 함수의 결과가 n개 행. 조회 컬럼 2개일 때 Map 을 사용한다면 .... -->
  <!-- 여기서 Map 은 최종 타입이 아니라 List 의 제너릭타입 -->
    SELECT EXTRACT(YEAR FROM BUY_DATE) AS year, COUNT(*) AS count
    FROM TBL_BUY tb
    GROUP BY EXTRACT(YEAR FROM BUY_DATE)
    ORDER BY year
</select>


  <!-- tbl_buy 테이블의 기본키는 buy_seq  -->
  <!-- 0806 문제 -->
  <select id="selectByCustomer" parameterType="string" resultType="BuyVo">
    SELECT *
    from TBL_BUY
    where CUSTOMER_ID=#{customerId}
  </select>
  <select id="selectByPcode" parameterType="string" resultType="BuyVo">
    SELECT *
    from TBL_BUY
    where pcode=#{pcode}
  </select>
  <select id="selectByYear" parameterType="string" resultType="BuyVo">
    SELECT *
    from TBL_BUY
    where to_char(BUY_DATE,'yyyy')=#{year}
  </select>
  <select id="selectSumByPcode" parameterType="string" resultType="int">
    <!-- 1개 행, 1개 컬럼 조회는 단일값 --> SELECT sum(quantity) from
    TBL_BUY where pcode=#{pcode} </select>
</mapper>
<!-- 

- - 사용자 구매 내역 조회 : selectByCustomer
SELECT *
from TBL_BUY
where CUSTOMER_ID='mina012';

- - 상품 구매 내역 조회  : selectByPcode
SELECT *
from TBL_BUY
where pcode='JINRMn5';

- - 년도 구매 내역 조회 : selectByYear
SELECT *
from TBL_BUY
where to_char(BUY_DATE,'yyyy')='2024'

- - 상품의 구매 수량 합계 조회 : selectSumByPcode  참고 : resultType="int"
SELECT sum(quantity)      
from TBL_BUY
where pcode='JINRMn5';
-->